<template>
  <div>
    <Form ref="form" :model="form" :rules="rule" :label-width="115">
      <div class="base-mess">
        <h2 class="title">基础和扩展信息</h2>
        <Row>
          <Col :span="10">
            <FormItem label="品牌中文名称:" prop="name">
              <span>{{form.name}}</span>
            </FormItem>
          </Col>
          <Col :offset="2" :span="10">
            <FormItem label="品牌外文名称:" prop="enName">
              <span>{{form.enName}}</span>
            </FormItem>
          </Col>
        </Row>
        <Row>
          <Col :span="10">
            <FormItem :show-message="form.logo.length == 0" label="品牌logo:" prop="logo">
              <Upload readonly v-model="form.logo" :maxCount="1" accept="image/*" />
            </FormItem>
          </Col>
          <Col :offset="2"  :span="6">
            <FormItem label="品牌大图:" prop="headImgBig">
              <Upload readonly v-model="form.headImgBig" :maxCount="1" accept="image/*" />
            </FormItem>
          </Col>
        </Row>
        <Row>
          <Col :span="10">
            <FormItem label="所属行业:" prop="tradeCode">
              <span>{{form.tradeCode}}</span>
            </FormItem>
          </Col>
          <Col :offset="2"  :span="10">
            <FormItem label="所属国家:">
              <span>{{form.countryCode}}</span>
            </FormItem>
          </Col>
        </Row>
        <Row>
          <Col :span="10" >
            <FormItem label="创始人:">
              <span>{{form.founder}}</span>
            </FormItem>
          </Col>
          <Col :span="10" :offset="2" >
            <FormItem label="创立时间:">
              <span>{{form.foundDate}}</span>
            </FormItem>
          </Col>
        </Row>
        <Row>
          <Col :span="12">
            <FormItem label="品牌口号:">
              <span>{{form.companySlogan}}</span>
            </FormItem>
          </Col>
        </Row>
        <Row>
          <Col :span="12">
            <FormItem label="简介修改:" prop="description">
              <span>{{form.description}}</span>
            </FormItem>
          </Col>
        </Row>
        <Row>
          <Col :span="10" >
            <FormItem label="搜索关键字:">
              <span>{{form.keyWords}}</span>
            </FormItem>
          </Col>
        </Row>
      </div>

      <div class="base-mess">
        <h2 class="title">粉丝画像信息</h2>
        <Row>
          <Col :span="6">
            <FormItem label="粉丝性别占比" prop="malePercent" class="rest-input">
              <div>
                男性：<span>{{form.malePercent}}</span>
              </div>
            </FormItem>
          </Col>
          <Col :span="6">
            <FormItem label prop="femalePercent" :labelWidth="0" class="rest-input">
              <div>
                女性：<span>{{form.femalePercent}}</span>
              </div>
            </FormItem>
          </Col>
        </Row>
        <FormItem label="粉丝年龄区间">
          <Table
            :columns="ageColumns"
            :data="ageCodeList"
            class="brand-table rest-input"
            border
            stripe
            disabled-hover
          >
            <template slot="v" slot-scope="{row, index}">
              <span>{{row.v}}</span>
            </template>
          </Table>
        </FormItem>
        <FormItem label="粉丝省市分布">
          <Table
            :columns="provinceColumns"
            :data="fans.provinces"
            class="brand-table"
            border
            stripe
            disabled-hover
          >
          </Table>
        </FormItem>
        <FormItem label="粉丝城市分布">
          <Table
            :columns="cityColumns"
            :data="fans.citys"
            class="brand-table"
            border
            stripe
            disabled-hover
          >
          </Table>
        </FormItem>
      </div>

      <div class="base-mess">
        <h2 class="title">推荐信息</h2>
        <FormItem label="推荐的KOL列表:">
          <kol :editnums="edit" :channelCodeList="channelCodeList" v-model="kollist"></kol>
        </FormItem>
        <FormItem label="推荐的影片列表:">
          <Film :editnums="edit" v-model="filmlist"></Film>
        </FormItem>
      </div>
      <div class="footer-btn">
        <Button type="primary" class="btn">浏览</Button>
        <Button type="primary" @click="editSubmit">返回</Button>
      </div>
    </Form>
  </div>
</template>

<script lang='ts'>
import { Component, Watch } from 'vue-property-decorator'
import ViewBase from '@/util/ViewBase'
import { confirm, info, alert } from '@/ui/modal.ts'
import { personDetail, queryPro, queryCtiy, editPersonal } from '@/api/person'
import { brandbefore, editbrand, addbrand, brandDetail } from '@/api/brand'
import moment from 'moment'
import AreaSelect, { areaParam } from '@/components/areaSelect'
import Upload from '@/components/Upload.vue'
import kol from './kol/kolist.vue'
import Film from './kol/film.vue'
import { clean } from '@/fn/object'
import { toMap } from '@/fn/array'

const makeMap = (list: any[]) => toMap(list, 'key', 'text')
const timeFormat = 'YYYYMMDD'
@Component({
  components: {
    AreaSelect,
    Upload,
    kol,
    Film
  }
})
export default class Main extends ViewBase {
  ass = []
  form: any = {
    name: '',
    enName: '',
    logo: [],
    foundDate: '',
    countryCode: '',
    tradeCode: '',
    founder: '',
    companySlogan: '',
    description: '',
    femalePercent: '',
    malePercent: '',
    headImgBig: [],
  }

  edit: any = 'detail'

  fans: any = {
    provinces: [], // 省份分布
    citys: [] // 城市分布
  }

  kollist: any = []
  filmlist: any = []
  ageCodeList: any = []
  channelCodeList: any = []
  countryCodeList: any = []
  tradeCodeList: any = []
  detaiId = ''
  itemList = {}

  options: any = {
    disabledDate(date: any) {
      return date && date.valueOf() > Date.now()
    }
  }
  get rule() {
    const jinyu = (rule: any, value: any, callback: any) => {
      const jinyureg: any = /^[0-9]+(.[0-9]{2})?$/
      if (value == '') {
        return callback()
      }
      if (!jinyureg.test((value + ''))) {
        return callback(new Error('格式不对'))
      } else {
        if (value > 100) {
          return callback(new Error('数字不能大于100'))
        } else {
          return callback()
        }
      }
    }
    return {
      name: [
        { required: true, message: '品牌中文名称', trigger: 'blur' }
      ],
      logo: [{
        required: true, type: 'array', len: 1, message: '请上传图片', trigger: 'change'}
      ],
      tradeCode: [
        { required: true, message: '请选择行业', trigger: 'change' }
      ],
      description: [
        { required: true, message: '请输入描述', trigger: 'blur' }
      ],
      malePercent: [
        { validator: jinyu, trigger: 'change' }
      ],
      femalePercent: [
        { validator: jinyu, trigger: 'change' }
      ],
    }
  }

  // 粉丝年龄区间
  ageColumns = [
    { title: '年龄区间', key: 'text', align: 'center' },
    { title: '粉丝占比', slot: 'v', align: 'center' }
  ]
  // ageData = []

  // 省份分布
  promodel = ''
  proSearchList = []
  provinceRatio = ''
  provinceColumns = [
    { title: '省份', key: 'name', align: 'center' },
    { title: '粉丝数占比%', key: 'rate', align: 'center' },
  ]
  // provinceData: any = []

  // 城市分布
  citySearchList = []
  citymodel = ''
  cityRatio: any = ''
  cityColumns = [
    { title: '城市', key: 'name', align: 'center' },
    { title: '粉丝数占比%', key: 'rate', align: 'center' },
  ]

  logo(val: any) {
  }

  bigimage(val: any) {}

  mounted() {
    this.detaiId = this.$route.params.id
    this.queryProvince()
    this.queryCity()
    this.init()
  }

  created() {
    this.brandbeforelist()
  }

  async init() {
    try {
      if (!this.$route.params.id) {
        return
      }
      const {
        data: { item }
      } = await brandDetail(this.$route.params.id)
        this.form.name = item.name
        this.form.enName = item.enName
        this.form.logo = item.logo ? [
          {
            url: item.logoUrl,
            fileId: item.logo
          }
        ] : []
        this.form.foundDate = this.formatDate(item.foundDate)
        this.form.countryCode = item.countryCode
        this.form.tradeCode = item.tradeCode
        this.form.founder = item.founder
        this.form.companySlogan = (item.companySlogan || '')
        this.form.description = item.description
        this.form.femalePercent = item.femalePercent
        this.form.malePercent = item.malePercent
        this.ageCodeList = item.ages ? (this.ageCodeList || []).map((it: any, index: number) => {
          return {
            ...it,
            v: item.ages[index].v,
            k: item.ages[index].v
          }
        }) : []
        this.fans.provinces = item.provinces || []
        this.fans.citys = item.citys || []
        // this.fans.citys = item.citys || []
        //   provinces: item.provinces || [], // 省份分布
        //   citys: item.citys || []
        // }
        const trade = makeMap(this.tradeCodeList)
        const country = makeMap(this.countryCodeList)
        this.form.countryCode = country[item.countryCode]
        this.form.tradeCode = trade[item.tradeCode]
        this.form.keyWords = (item.keyWords || []).join(';')
        this.filmlist = item.movies || []
        this.form.headImgBig = item.headImgBig ? [
          {
            url: item.headImgBigUrl,
            fileId: item.headImgBig
          }
        ] : []
        this.kollist = (item.kols || []).map((it: any) => {
          return {
            ...it,
            name: this.channelCodeList.filter((items: any) => {
              return items.key == it.channelCode
            })[0].text,
            rate: it.channelName
          }
        })
    } catch (ex) {
      this.handleError(ex)
    }
  }

  formatDate(data: any) {
    return data ? `${(data + '').slice(0, 4)}-${(data + '').substr(4, 2)}-${(data + '').substr(6, 2)}` : '暂无'
  }

  async brandbeforelist() {
    try {
      const {
        data: { ageCodeList, channelCodeList, countryCodeList, tradeCodeList }
      } = await brandbefore()
      this.ageCodeList = (ageCodeList || []).map((it: any) => {
        return {
          ...it,
          k: it.key,
          v: 0,
        }
      })
      this.channelCodeList = channelCodeList
      this.countryCodeList = countryCodeList
      this.tradeCodeList = tradeCodeList
    } catch (ex) {
      this.handleError(ex)
    }
  }

  // 省查询
  async queryProvince() {
    try {
      const {
        data: { items }
      } = await queryPro({
        parentIds: 0,
        pageIndex: 1,
        pageSize: 8888888
      })
      this.proSearchList = items
    } catch (ex) {
      this.handleError(ex)
    }
  }
  // 市查询
  async queryCity() {
    try {
      const {
        data: { items }
      } = await queryCtiy({
        pageIndex: 1,
        pageSize: 8888888
      })
      this.citySearchList = items
    } catch (ex) {
      this.handleError(ex)
    }
  }

  async addProvinceList() {
    if (this.promodel != '' && this.provinceRatio != '') {
      const jinyu: any = /^[0-9]{0,2}(.[0-9]{2})?$/
      if (!jinyu.test((this.provinceRatio + ''))) {
        info('粉丝占比应该为不大于100的数字')
        return
      }
      let proname: string = ''
      this.proSearchList.map((item: any) => {
        if (item.id == this.promodel) {
          proname = item.nameCn
        }
      })
      // 省是否存在
      const ishas = this.fans.provinces.some(
        (item: any) => item.id == this.promodel
      )
      if (!ishas) {
        this.fans.provinces.push({
          id: this.promodel,
          name: proname,
          rate: this.provinceRatio
        })
      } else {
        await info('请选择城市已经存在', { title: '提示' })
      }
    } else {
      await info('请选择省份或者粉丝占比', { title: '提示' })
    }
  }

  async addCityList() {
    if (this.citymodel != '' && this.cityRatio != '') {
      const jinyu: any = /^[0-9]{0,2}(.[0-9]{2})?$/
      if (!jinyu.test((this.cityRatio + '')) && this.cityRatio > 100) {
        info('粉丝占比应该为不大于100的数字')
        return
      }
      let proname: string = ''
      this.citySearchList.map((item: any) => {
        if (item.id == this.citymodel) {
          proname = item.nameCn
        }
      })
      // 城市是否存在
      const ishas = this.fans.citys.some((item: any) => item.id == this.citymodel)
      if (!ishas) {
        this.fans.citys.push({
          id: this.citymodel,
          name: proname,
          rate: this.cityRatio
        })
      } else {
        await info('请选择城市已经存在', {
          title: '提示'
        })
      }
    } else {
      await info('请选择城市或者粉丝占比', {
        title: '提示'
      })
    }
  }

  updataRow(row: any, ind: number) {
    if (row.v == '') {
      row.v = 0
    }
    this.ageCodeList.splice(ind, 1, row)
  }

  // 提交
  async editSubmit() {
    this.$router.push({ name: 'data-brand' })
  }
}
</script>
<style lang='less' scoped>
.base-mess {
  font-size: 14px;
  border: solid 1px #ededed;
  padding: 10px 15px;
  margin-bottom: 15px;
  background: #fff;
  .title {
    font-size: 14px;
    padding-bottom: 20px;
  }
  .ivu-col {
    p {
      padding-bottom: 15px;
      display: flex;
      label {
        display: block;
        width: 90px;
      }
    }
  }
  .hot-word {
    display: -webkit-box;
  }
}
/deep/ .ivu-form {
  .ivu-form-item-label {
    font-size: 14px;
  }
}
.brand-table {
  width: 362px;
  margin-top: 15px;
  /deep/ .ivu-table {
    background: none;
    &::before {
      background-color: none;
    }
  }
  .del-col {
    cursor: pointer;
    color: #2d8cf0;
  }
}
.brand-select {
  /deep/ .ivu-select {
    margin-right: 10px;
  }
}
.footer-btn {
  text-align: center;
  .btn {
    margin-right: 15px;
  }
}
span:only-child:empty {
  &::before {
    content: '暂无';
  }
}
</style>